---
interface Props {
  anime: {
    defaultStreamingUrl: string;
    server: { qualities: Quality[] };
  };
  episodeId?: string;
  animeId?: string;
  nextEpisodeUrl?: string;
}

const { anime, episodeId, animeId, nextEpisodeUrl } = Astro.props;
---

<select
  id="servers"
  class="bg-zinc-50 border border-zinc-300 text-zinc-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-zinc-700 dark:border-zinc-600 dark:placeholder-zinc-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
>
  <option selected value={anime.defaultStreamingUrl} id="default-server"
    >Server Bawaan</option
  >
  {
    anime.server.qualities.map((quality) => {
      if (quality.serverList && quality.serverList.length > 0) {
        return (
          <>
            <option disabled>{quality.title}</option>
          
            {quality.serverList?.map((server) => (
              <option value={server.serverId}>{server.title}</option>
            ))}
          </>
        );
      }
    })
  }
</select>
<div
  id="video-player-wrapper"
  class="flex justify-center items-center aspect-video bg-zinc-300 dark:bg-zinc-700 rounded-lg overflow-hidden"
>
  {
    anime.defaultStreamingUrl.toLowerCase() === "no iframe found" ?
    (
      <h5 class="text-lg font-extrabold">Server Tidak Tersedia</h5>
    ) : anime.defaultStreamingUrl.endsWith(".mp4") ?
    (
      <video
        id="video-player-video"
        class="w-full h-full"
        controls
        src={anime.defaultStreamingUrl}
      />
    ) : (
      <iframe
        id="video-player-iframe"
        src={anime.defaultStreamingUrl}
        allowfullscreen
        class="w-full h-full"
      />
    
    )
  }
</div>

<script define:vars={{ episodeId, animeId, nextEpisodeUrl }}>
  import { savePlaybackProgress, getPlaybackProgress } from '../services/playbackService';
  import { addToWatchHistory } from '../services/watchHistoryService';
  import { getSkipTimes } from '../services/skipTimesService';

  const selectEl = document.getElementById("servers");
  const defaultServerEl = document.getElementById("default-server");
  const videoPlayerWrapper = document.getElementById("video-player-wrapper");

  let currentVideo = null;
  let skipTimes = null;
  let autoNextEnabled = true;
  let progressSaveInterval = null;

  if (animeId) {
    getSkipTimes(animeId).then(times => {
      skipTimes = times;
    });
  }

  function setupVideoListeners(videoEl) {
    if (!videoEl || !episodeId) return;

    currentVideo = videoEl;

    getPlaybackProgress(episodeId).then(progress => {
      if (progress && progress.position > 10) {
        const shouldResume = confirm(`Lanjutkan dari ${formatTime(progress.position)}?`);
        if (shouldResume) {
          videoEl.currentTime = progress.position;
        }
      }
    });

    videoEl.addEventListener('timeupdate', () => {
      if (skipTimes) {
        const currentTime = videoEl.currentTime;

        if (skipTimes.intro_start > 0 && currentTime >= skipTimes.intro_start && currentTime < skipTimes.intro_end) {
          showSkipButton('intro', skipTimes.intro_end);
        } else if (skipTimes.outro_start > 0 && currentTime >= skipTimes.outro_start && currentTime < skipTimes.outro_end) {
          showSkipButton('outro', skipTimes.outro_end);
        } else {
          hideSkipButton();
        }
      }
    });

    videoEl.addEventListener('ended', () => {
      if (autoNextEnabled && nextEpisodeUrl) {
        setTimeout(() => {
          window.location.href = nextEpisodeUrl;
        }, 3000);
      }
    });

    progressSaveInterval = setInterval(() => {
      if (!videoEl.paused && episodeId) {
        savePlaybackProgress(episodeId, Math.floor(videoEl.currentTime), Math.floor(videoEl.duration));
      }
    }, 10000);

    videoEl.addEventListener('pause', () => {
      if (episodeId) {
        savePlaybackProgress(episodeId, Math.floor(videoEl.currentTime), Math.floor(videoEl.duration));
      }
    });
  }

  function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  }

  function showSkipButton(type, skipTo) {
    let btn = document.getElementById('skip-button');
    if (!btn) {
      btn = document.createElement('button');
      btn.id = 'skip-button';
      btn.className = 'fixed bottom-24 right-8 bg-amber-600 hover:bg-amber-700 text-white px-6 py-3 rounded-lg font-semibold shadow-lg z-50 transition-all';
      document.body.appendChild(btn);
    }
    btn.textContent = type === 'intro' ? 'Skip Intro' : 'Skip Outro';
    btn.style.display = 'block';
    btn.onclick = () => {
      if (currentVideo) {
        currentVideo.currentTime = skipTo;
      }
      hideSkipButton();
    };
  }

  function hideSkipButton() {
    const btn = document.getElementById('skip-button');
    if (btn) {
      btn.style.display = 'none';
    }
  }

  function cuss(src) {
    if (progressSaveInterval) {
      clearInterval(progressSaveInterval);
    }

    if (src.endsWith(".mp4")) {
      videoPlayerWrapper.innerHTML = `
        <video
          id="video-player-video"
          class="w-full h-full"
          controls
          src=${src}
        />
      `;
      const videoEl = document.getElementById('video-player-video');
      setupVideoListeners(videoEl);
    } else {
      videoPlayerWrapper.innerHTML = `
        <iframe
          id="video-player-iframe"
          class="w-full h-full"
          allowfullscreen
          src=${src}
        />
      `;
    }
  }

  const initialVideo = document.getElementById('video-player-video');
  if (initialVideo) {
    setupVideoListeners(initialVideo);
  }

  selectEl.addEventListener("change", async function () {
    videoPlayerWrapper.innerHTML = `
      <span id="video-player-spinner" class="loader" />
    `;

    const value = this.value;

    if (value.startsWith("http") || value.startsWith("//")) {
        cuss(value);
        return;
    }

    if (value === defaultServerEl.value) {
      cuss(value);
    } else {
      try {
        const response = await fetch(`/api/server/${value}`, {
          method: "POST",
        });
        const data = await response.json();
        cuss(data?.url || defaultServerEl.value);
      } catch (error) {
        videoPlayerWrapper.innerHTML = `
          <h5 class="text-lg font-extrabold">Server Tidak Tersedia</h5>
        `;
      }
    }
  });
</script>
